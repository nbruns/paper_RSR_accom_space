---
title: Make figures for paper exploring how root to shoot ratio impacts acomodation
  space
author: "Nicholas Bruns"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(patchwork)
dir_name_c_model <- "~/projects/marsh_column_model-master/"
dir_name_r_project <- "~/projects/paper_RSR_accom_space/"


#set theme
theme_paper_ready <- function(base_size = 14, base_family = "",axis_size_adjust=2) {
  theme_classic(base_size = base_size, base_family = base_family) +
    theme(
      text = element_text(size = base_size),
      axis.title = element_text(size = base_size + axis_size_adjust),
      axis.text = element_text(size = base_size),
      legend.position = "right",
      legend.title = element_text(size = base_size),
      legend.text = element_text(size = base_size - 2),
      plot.title = element_text(size = base_size + 4, face = "bold"),
      plot.subtitle = element_text(size = base_size)
    )
}

# Set the custom theme as the default
theme_set(theme_paper_ready())

COLOR_SED_LOW <- "#D3D3D3"# "lightgrey"
COLOR_SED_HIGH <- "#696969"#"darkgrey"
SED_CONC_LOW <- .005
# SED_CONC_HIGH <- .05
SED_CONC_HIGH <- .03

RSR_LOW <- 1
RSR_HIGH <- 4
```

```{r load-data}

series_column_names <-c("Yr", "MHT", "Elevation", "Biomass", 
                        "Silt", "Ref", "Lab","extra_column")

series_column_names_ADD_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                        "Silt", "Ref", "Lab","Accretion_rate","extra_column")

file_name_vec <- c("series.00.txt", "series.01.txt", "series.10.txt", "series.11.txt")


run_string_vec <- c("00","01","10","11")

all_runs <- tibble()
for(cur_run_string in run_string_vec ){
  cur_file_name <- paste0("series.",cur_run_string,".txt")
    
  cur_data <- read_delim(
    paste0(dir_name_c_model,cur_file_name), 
    delim = " ", 
    col_names = series_column_names,
    trim_ws = TRUE) %>% 
    select(-extra_column) %>% 
    mutate(Yr=Yr+2010) %>% 
    mutate(run_code=cur_run_string)
   
  
  all_runs <- bind_rows(all_runs,cur_data) 
}

all_runs %>% glimpse()


```


```{r reproduce-k-mud-fig-3}

# scenario_plot_CAR <- 
  
# scenario_plot_accretion <-
  
# scenario_plot_CAR | scenario_plot_accretion
  
```



```{r fig-1-rsr-adjust-LOAD-DATA}
dir_name_fig_2_results <- "RSR_adjust_constant_SLR"
run_dir_full_name<- paste0("../source_cpp_model/model_output/", dir_name_fig_2_results,"/")
                       
series_column_names_NO_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                          "Silt", "Ref", "Lab","extra_column")
  

  # run_string_vec <- c("00","01","10","11")
  # run_string_vec <- c( "0.000", "0.001", "0.005", "0.050")
  rsr_adjust_file_names <- list.files(run_dir_full_name)
 
   SLR_pattern <- "SLR_([0-9.]+)\\.txt" # regex for extracting SLR rate
   sed_pattern <- "sed_([0-9.]+)\\_" # regex for extracting SLR rate
   rsr_pattern <- "(?<=RSR2_)[0-9.]+" #"RSR2_([0-9.]+)\\_" # regex for extracting SLR rate
 
   
RSR_adjust_tibble <- tibble()
  for(cur_file_name in list.files(run_dir_full_name)){
    # cur_file_name <- equilibrium_run_files[4] #run name
    # slr_rate <- str_extract(cur_file_name, pattern) %>%  
   # cur_file_name <- rsr_adjust_file_names[2]
    cur_sed_conc <- str_extract(cur_file_name, sed_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      as.numeric()
   
    cur_rsr <-  str_extract(cur_file_name, rsr_pattern) %>%
    # str_extract(cur_file_name, rsr_pattern) %>%
      # str_extract("[0-9.]+")  %>% 
      as.numeric() 
      
    print(cur_rsr)
  
    cur_SLR <-  str_extract(cur_file_name, SLR_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
    
    cur_data <- read_delim(
      paste0(run_dir_full_name,cur_file_name),
      delim = " ", 
      col_names = series_column_names_NO_ACRETION,
      trim_ws = TRUE) %>% 
      select(-extra_column) %>% 
      # mutate(Yr=Yr+2010) %>%
        # filter(Yr>1980) %>%
      mutate(sed_conc=cur_sed_conc,
             SLR=cur_SLR,
             RSR=cur_rsr)
    
    cur_data <- cur_data %>% 
        mutate(accretion_mm_yr=Elevation-lag(Elevation)) %>% 
        mutate(accretion_mm_yr=accretion_mm_yr*1000) %>% 
        mutate(silt_deposition_g_yr=Silt - lag(Silt)) %>% 
        mutate(depth=MHT-Elevation) %>% 
        mutate(total_C=Ref+Lab) %>% 
        mutate(CAR_g_yr=total_C - lag(total_C)) 
        
    RSR_adjust_tibble <- bind_rows(RSR_adjust_tibble,cur_data) 
  }
 
  
  glimpse(RSR_adjust_tibble)

  RSR_adjust_tibble %>% pull(RSR) %>% table()
  RSR_adjust_tibble %>% pull(sed_conc) %>% table()
```

```{r fig-1-rsr-adjust-MAKE-PLOT-FULL}
# recquires RSR_adjust_tibble


fig_1_make_plot <- function(results_tibble_arg,slr_arg){
  
  low_sed <- results_tibble_arg %>% 
    # filter(rsr %in% c(1,3)) %>% 
    filter(RSR %in% c(RSR_LOW,RSR_HIGH)) %>% 
    filter(sed_conc==SED_CONC_LOW) %>% 
    
    select(
     Yr,sed_conc,SLR,
     RSR,
     accretion_mm_yr,CAR_g_yr,Biomass,depth,silt_deposition_g_yr
    ) %>% 
    filter(Yr>50) %>% 
    filter(SLR==slr_arg) %>% 
    pivot_longer(-c(Yr,sed_conc,SLR,RSR)) %>% 
    ggplot(aes(x=Yr,y=value,group=as.factor(RSR),color=as.factor(RSR))) +
    geom_line() +
    # facet_grid(name~sed_conc,scales = "free_y") +
    facet_wrap(~name,scales = "free_y",ncol=1) +
    scale_color_manual(values= c("darkgreen","brown"),"root:shoot ratio") +
    ggtitle(paste0("SLR: ",slr_arg,", sed: 5 mg/L")) +
    ylab(NULL)
    # ggplot(aes(x=Yr,y=))
   # low_sed 
   
  high_sed <- results_tibble_arg %>% 
      # filter(rsr %in% c(1,3)) %>% 
      filter(RSR %in% c(RSR_LOW,RSR_HIGH)) %>% 
    filter(sed_conc==SED_CONC_HIGH) %>% 
    select(
     Yr,sed_conc,SLR,
     RSR,
     accretion_mm_yr,CAR_g_yr,Biomass,depth,silt_deposition_g_yr
    ) %>% 
    filter(Yr>50) %>% 
    filter(SLR==slr_arg) %>% 
    pivot_longer(-c(Yr,sed_conc,SLR,RSR)) %>% 
    ggplot(aes(x=Yr,y=value,group=as.factor(RSR),color=as.factor(RSR))) +
    geom_line() +
    # facet_grid(name~sed_conc,scales = "free_y") +
    facet_wrap(~name,scales = "free_y",ncol=1) +
    scale_color_manual(values= c("darkgreen","brown"),"root:shoot ratio") +
    ylab(NULL)+
    ggtitle(paste0("SLR: ",slr_arg,", sed: ",SED_CONC_HIGH*1000, "mg/L")) 
    # ggplot(aes(x=Yr,y=))
   (low_sed  | high_sed) + plot_layout(guides = 'collect')
   
}


# fig_1_make_plot (RSR_adjust_tibble,.003) 
fig_1_make_plot (RSR_adjust_tibble,.01)  # .0125 is interesting-- as pct car on decrease is same
# fig_1_make_plot (RSR_adjust_tibble,.001) 
 
 
```


```{r fig-1-rsr-adjust-MAKE-PLOT-SIMPLE}
# recquires RSR_adjust_tibble

rsr_adjust_plot_ACCRETION <- function(results_tibble,slr_arg,sed_conc_arg){
  results_tibble %>% 
    filter(RSR %in% c(RSR_LOW,2,RSR_HIGH)) %>% 
    filter(sed_conc==sed_conc_arg) %>% 
    filter(Yr>50) %>% 
    filter(SLR==slr_arg) %>% 
    ggplot(aes(x=Yr,y=accretion_mm_yr,group=as.factor(RSR),color=as.factor(RSR))) +
    geom_line() +
    geom_line(data = . %>% filter(Yr<100),color="black") +
    # scale_color_manual(values= c("darkgreen","black","brown"),"root:shoot ratio") +
    scale_color_manual(values= c("darkgreen","black","brown"),"root:shoot ratio") +
    ggtitle(paste0("SLR: ",slr_arg,", sed: ",sed_conc_arg ,"mg/L")) +
    ylab("accretion rate (mm/yr)")
}

 rsr_adjust_plot_CAR <- function(results_tibble,slr_arg,sed_conc_arg){
                           
  results_tibble %>% 
    filter(RSR %in% c(RSR_LOW,2,RSR_HIGH)) %>% 
    filter(sed_conc==sed_conc_arg) %>% 
    filter(Yr>50) %>% 
    filter(SLR==slr_arg) %>% 
    ggplot(aes(x=Yr,y=CAR_g_yr,group=as.factor(RSR),color=as.factor(RSR))) +
    geom_line() +
    geom_line(data = . %>% filter(Yr<100),color="black") +
    # scale_color_manual(values= c("darkgreen","black","brown"),"root:shoot ratio") +
    scale_color_manual(values= c("darkgreen","black","brown"),"root:shoot ratio") +
    # ggtitle(paste0("SLR: ",slr_arg,", sed: 5 mg/L")) +
    ylab("organic matter accumulation (g/yr)")
}

make_fig_1_SIMPLE <- function(slr_arg){
  
    
  CAR_sed_low <- rsr_adjust_plot_CAR(results_tibble = RSR_adjust_tibble,
                                     slr_arg =  slr_arg,
                                     sed_conc_arg =  SED_CONC_LOW)
  
   CAR_sed_high <- rsr_adjust_plot_CAR(results_tibble = RSR_adjust_tibble,
                                     slr_arg =  slr_arg,
                                     sed_conc_arg =  SED_CONC_HIGH)
  
   ACC_sed_low <- rsr_adjust_plot_ACCRETION(results_tibble = RSR_adjust_tibble,
                                     slr_arg =  slr_arg,
                                     sed_conc_arg =  SED_CONC_LOW)
  
   ACC_sed_high <- rsr_adjust_plot_ACCRETION(results_tibble = RSR_adjust_tibble,
                                     slr_arg =  slr_arg,
                                     sed_conc_arg =  SED_CONC_HIGH)
  
    
     (ACC_sed_low | ACC_sed_high)/ 
    (CAR_sed_low | CAR_sed_high)  +
     plot_layout(guides = 'collect')
   
}

make_fig_1_SIMPLE(.01)
```



```{r fig-2-delta-C-MAKE-DATA}
#could load these 1 at a time and make table, so I could sweep a larger set
compute_delta_C <- function(sed_conc_arg,slr_arg,RSR_change_arg){
  low_RSR <- 1 #could make this an arg
  
  # sed_conc_arg <- .05
  # slr_arg <- .01
  
  
  cur_run <- RSR_adjust_tibble %>% 
    filter(sed_conc==sed_conc_arg) %>% 
    filter(SLR==slr_arg) %>% 
    filter(rsr %in% c(1,RSR_change_arg)) 
  
  baseline_year <- 99 
  final_year <- 199
  baseline_CAR <- cur_run %>%
  # cur_run %>% 
    filter(Yr==baseline_year) %>% 
    filter(rsr==low_RSR) %>% #they are identical, so just grab the first
    pull(CAR_g_yr)
  
  final_CAR<- cur_run %>%
  # cur_run %>%
    filter(rsr==RSR_change_arg) %>% 
    filter(Yr==final_year) %>% 
    pull(CAR_g_yr)
    
  
  (final_CAR- baseline_CAR)/baseline_CAR
}


slr_vec <- RSR_adjust_tibble %>% pull(SLR) %>% unique() %>% as.numeric()
sed_conc_vec <- RSR_adjust_tibble %>% pull(sed_conc) %>% unique() %>% as.numeric()
RSR_vec <- RSR_adjust_tibble %>% pull(rsr) %>% unique() %>% as.numeric()

fig_2_tibble <- tibble()
for(cur_slr in slr_vec){
  for(cur_sed_conc in sed_conc_vec){
    for(cur_RSR in RSR_vec){
      # cur_sed_conc <- sed_conc_vec[1]
      # cur_slr <- slr_vec[1]
      # cur_RSR <- RSR_vec[1]
      
       cur_delta_c_pcnt <- compute_delta_C(
         sed_conc_arg = cur_sed_conc,
         slr_arg =  cur_slr,
         RSR_change_arg= cur_RSR)
       
       
       
       cur_row <- tibble(delta_c_pcnt=cur_delta_c_pcnt,
                         sed_conc=cur_sed_conc,
                         SLR=cur_slr,
                         RSR=cur_RSR
                         )
       fig_2_tibble <- bind_rows(fig_2_tibble,cur_row)
    }
  }
}

fig_2_tibble %>% glimpse()

```

```{r fig-2-delta-C-MAKE-PLOT}

fig_2_tibble %>% 
  pull(SLR) %>% 
  unique()

slr_vec <- c(.001,.0025,.0050,.0075,.01,.0125,.015,.2)
fig_2_tibble %>% 
  filter(SLR %in% slr_vec)   %>% 
  filter(RSR %in% c(RSR_LOW,RSR_HIGH)) %>% 
  filter(sed_conc %in% c(SED_CONC_LOW,SED_CONC_HIGH)) %>%
  filter(!(sed_conc == SED_CONC_LOW & SLR >= 0.015)) %>%  # Additional filter condition
  mutate(SLR_mm_yr =SLR*1000) %>% 
  mutate(sed_conc_mg_l=sed_conc*1000) %>% 
  ggplot(aes(x = SLR_mm_yr, y = delta_c_pcnt, color = as.factor(sed_conc_mg_l), group = interaction(sed_conc_mg_l, RSR))) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  labs(color = "Sed. Conc. (mg/L)") +  # Optionally add a label for the legend
  # scale_color_brewer(palette = "Set1") +
  scale_color_manual(values = c(COLOR_SED_LOW,COLOR_SED_HIGH)) +
  ylab("% change in organic matter accumulation rate") +
  xlab("sea level rise rate (mm/yr)") +
  theme_classic()


```

```{r fig-2-delta-C-ALT-VIEW}
fig_2_tibble %>% 
  # filter(SLR %in% )
  filter(SLR !=.003) %>% 
  filter(delta_c_pcnt>-.5) %>% 
  filter(RSR %in% c(RSR_LOW,RSR_HIGH)) %>% 
  # ggplot(aes(x = sed_conc, y = delta_c_pcnt, color = as.factor(SLR), group = interaction(SLR, RSR))) +
  ggplot(aes(x = sed_conc, y = delta_c_pcnt, color = SLR, group = interaction(SLR, RSR))) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  # labs(color = "Sed. Conc. (mg/L)") +  # Optionally add a label for the legend
  labs(color = "SLR (m/yr)") +  # Optionally add a label for the legend
  # scale_color_brewer(palette = "Set1")
  scale_color_viridis_c()

```

```{r fig-3-threshold-SLR-LOAD-DATA}
find_slr_results <- "equilibrium_get_drowning_slr" #"dev_out"
run_dir_full_name<- paste0("../source_cpp_model/model_output/",
                           find_slr_results,"/")
                       
series_column_names_NO_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                          "Silt", "Ref", "Lab","extra_column")
  

  # run_string_vec <- c("00","01","10","11")
  # run_string_vec <- c( "0.000", "0.001", "0.005", "0.050")
 
   sed_pattern <-  "conc_([0-9.]+)\\.txt"
   rsr_pattern <- "RSR_([0-9.]+)\\_" # regex for extracting SLR rate
 
   
get_slr_tibble <- tibble()
  for(cur_file_name in list.files(run_dir_full_name)){
    # cur_file_name <- equilibrium_run_files[4] #run name
    # slr_rate <- str_extract(cur_file_name, pattern) %>%  
    cur_sed_conc <- str_extract(cur_file_name, sed_pattern) %>%
      str_extract("[0-9]+\\.[0-9]+") %>% as.numeric()
    print(cur_sed_conc)
    
    cur_rsr <-  str_extract(cur_file_name, rsr_pattern) %>%
      str_extract("[0-9.]+")  %>%
      as.numeric() 
   
    cur_data <- read_delim(
      paste0(run_dir_full_name,cur_file_name),
      delim = " ", 
      col_names = series_column_names_NO_ACRETION,
      trim_ws = TRUE) %>% 
      select(-extra_column) %>% 
      # mutate(Yr=Yr+2010) %>%
        # filter(Yr>1980) %>%
      mutate(sed_conc=cur_sed_conc,
             # SLR=cur_SLR,
             rsr=cur_rsr)
    
    cur_data <- cur_data %>% 
        mutate(accretion_mm_yr=Elevation-lag(Elevation)) %>% 
        mutate(accretion_mm_yr=accretion_mm_yr*1000) %>% 
        mutate(silt_deposition_g_yr=Silt - lag(Silt)) %>% 
        mutate(depth=MHT-Elevation) %>% 
        mutate(total_C=Ref+Lab) %>% 
        mutate(CAR_g_yr=total_C - lag(total_C))  %>% 
        mutate(SLR=MHT-lag(MHT)) %>% 
      mutate(SLR=round(SLR*1000)) %>% 
      filter(Yr>10) 
       
    get_slr_tibble <- bind_rows(get_slr_tibble,cur_data) 
  }
 
  
  glimpse(get_slr_tibble)
  get_slr_tibble %>% 
  select(rsr,SLR) %>% table()
 
```

```{r fig-3-threshold-SLR-MAKE-FIGURE}
 
custom_palette <- viridisLite::viridis(4)
custom_palette[4] <- "#D55E00"#"green"  # Change the color for factor level 4

get_slr_tibble %>% 
  filter(Yr == 200) %>% 
  ggplot(aes(x = sed_conc, y = SLR, color = as.factor(rsr))) +
  geom_point() +
  geom_line() +
  ylab("threshold SLR (mm/yr)") +
  xlab("sediment concentration (mg/L)") +
  scale_color_manual(values = custom_palette, name = "RSR") +
  labs(title="the impact or root:shoot ratio on threshold SLR" ,
  subtitle = "across sediment concentrations (mg/L)")
 
  # ggplot(aes(x=sed_conc,y=SLR))
```

```{r fig-3-zoom-in-on-each}
get_slr_tibble %>% 
  filter(Yr==200) %>% 
  mutate(sed_conc_mg_l=sed_conc*1000) %>% 
  # ggplot(aes(x=sed_conc,y=SLR,color=as.factor(rsr))) +
  ggplot(aes(x=rsr,y=SLR)) +
  geom_point() +
  facet_wrap(~sed_conc_mg_l,scales = "free_y",ncol=1) +
  ylab("threshold SLR (mm/yr)") +
  xlab("root:shoot") +
  labs(title="the impact or root:shoot ratio on threshold SLR" ,
  subtitle = "across sediment concentrations (mg/L)")
 
```


```{r fig-4-total-c-per-scenario-run-LOAD-DATA}
dir_name_fig_4_results <- "scenario_runs_fig_4"
run_dir_full_name<- paste0("../source_cpp_model/model_output/", dir_name_fig_4_results,"/")
                       
series_column_names_NO_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                          "Silt", "Ref", "Lab","extra_column")
  

  # run_string_vec <- c("00","01","10","11")
  # run_string_vec <- c( "0.000", "0.001", "0.005", "0.050")
 
   sed_pattern <- "sed_([0-9.]+)\\.txt" # regex for extracting SLR rate
   rsr_pattern <- "D_mbm_([0-9.]+)\\_" # regex for extracting SLR rate
 
   
  fig_4_scenario_runs <- tibble()
  for(cur_file_name in list.files(run_dir_full_name)){
    # cur_file_name <- equilibrium_run_files[4] #run name
    # slr_rate <- str_extract(cur_file_name, pattern) %>%  
    sed_conc <- str_extract(cur_file_name, sed_pattern) %>%  
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
   
    RSR <-  str_extract(cur_file_name, rsr_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
   
    print(RSR)
    print(sed_conc)
    
    cur_data <- read_delim(
      paste0(run_dir_full_name,cur_file_name),
      delim = " ", 
      col_names = series_column_names_NO_ACRETION,
      trim_ws = TRUE) %>% 
      select(-extra_column) %>% 
      # mutate(Yr=Yr+2010) %>%
        # filter(Yr>1980) %>%
      mutate(sed_conc=sed_conc) 
    
    #calculate additional fields 
    cur_data <- cur_data %>% 
      mutate(total_carbon=Lab+Ref)
    
    end_carbon <- cur_data %>% 
      slice_max(Yr) %>% pull(total_carbon)
    
    start_carbon <- cur_data %>% 
      filter(Yr==100) %>% 
      pull(total_carbon)
   
    carbon_accumulation <- end_carbon - start_carbon 
    cur_row <- tibble(carbon_accumulation,sed_conc,RSR)
    fig_4_scenario_runs <- bind_rows(fig_4_scenario_runs,cur_row) 
  }
  
  glimpse(fig_4_scenario_runs)

```

```{r fig-4-total-c-per-scenario-run-MAKE-PLOT}
leaf_color <- "green"
root_color <- "brown"
theme_set(theme_paper_ready(axis_size_adjust = 0))
# theme_set(theme_classic(base_size = 12))
fig_4_scenario_runs_baseline <- fig_4_scenario_runs %>%
# fig_4_scenario_runs %>% 
  filter(RSR ==2) %>% 
  glimpse()

fig_4_diff_data <- fig_4_scenario_runs %>%
  filter(RSR %in% c(1,2,4)) %>% 
  mutate(RSR=paste0("RSR_",RSR)) %>%
  pivot_wider(names_from = RSR, values_from = carbon_accumulation) %>% 
  mutate(pct_C_change_increase=(RSR_4-RSR_2)/RSR_2) %>% 
  mutate(pct_c_change_decrease=(RSR_1-RSR_2)/RSR_2)

left_panel_pct_difs <- fig_4_diff_data %>% 
  pivot_longer(starts_with("pct_C_")) %>% 
  ggplot(aes(x=sed_conc*1000,y=value*100,color=name)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  ylab("% change in organic matter accumulation") +
  xlab("sediment concentration (mg/L)") +
  scale_color_manual(values=c(root_color,leaf_color)) +
  theme(legend.position="none")
  



right_panel_absolute_numbers <- fig_4_scenario_runs %>% 
  mutate(sed_conc_mg=sed_conc*1000) %>% 
    ggplot(aes(x=RSR,y=carbon_accumulation,group=sed_conc_mg,color=as.factor(sed_conc_mg)))+
    geom_point() +
    geom_line() +
  scale_color_viridis_d( "sediment concentration (mg/L)") +
  ylab("total organic matter accumulation (g)") +
  xlab("root:shoot ratio")  +
  geom_vline(xintercept = 1,color=leaf_color,linetype="dotted",size=2) +
  geom_vline(xintercept = 2) +
  geom_vline(xintercept = 4,color=root_color,linetype="dotted",size=2) 

left_panel_pct_difs | right_panel_absolute_numbers
```

```{r fig-5-LOAD-DATA}

dir_name_fig_4_results <- "scenario_runs_fig_4"
run_dir_full_name<- paste0("../source_cpp_model/model_output/", dir_name_fig_4_results,"/")
                       
series_column_names_NO_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                          "Silt", "Ref", "Lab","extra_column")
  

  # run_string_vec <- c("00","01","10","11")
  # run_string_vec <- c( "0.000", "0.001", "0.005", "0.050")
 
   sed_pattern <- "sed_([0-9.]+)\\.txt" # regex for extracting SLR rate
   rsr_pattern <- "D_mbm_([0-9.]+)\\_" # regex for extracting SLR rate
 
  
   fig_5_values_sed <- c(SED_CONC_LOW,SED_CONC_HIGH) 
   fig_5_values_rsr <- c(1,2,4)
   
  fig_5_tibble <- tibble()
  for(cur_file_name in list.files(run_dir_full_name)){
    # cur_file_name <- equilibrium_run_files[4] #run name
    # slr_rate <- str_extract(cur_file_name, pattern) %>%  
    sed_conc <- str_extract(cur_file_name, sed_pattern) %>%  
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
   
    RSR <-  str_extract(cur_file_name, rsr_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
    
     
    print(RSR )
    print(sed_conc)
    if(sed_conc %in% fig_5_values_sed && RSR %in% fig_5_values_rsr){

      cur_data <- read_delim(
        paste0(run_dir_full_name,cur_file_name),
        delim = " ", 
        col_names = series_column_names_NO_ACRETION,
        trim_ws = TRUE) %>% 
        select(-extra_column) %>% 
        # mutate(Yr=Yr+2010) %>%
          # filter(Yr>1980) %>%
        mutate(sed_conc=sed_conc) %>% 
        mutate(RSR=RSR)
      
      #calculate additional fields 
      cur_data <- cur_data %>% 
        mutate(sed_conc_mg_l=sed_conc*1000) %>% 
        mutate(total_carbon=Lab+Ref) %>% 
        mutate(CAR_g_yr=total_carbon - lag(total_carbon)) %>% 
        mutate(accretion_mm_yr=Elevation-lag(Elevation)) %>% 
        mutate(accretion_mm_yr=accretion_mm_yr*1000) 
      
      fig_5_tibble <- bind_rows(fig_5_tibble,cur_data) 
    }
  }
  
  glimpse(fig_5_tibble)

```

```{r  fig-5-MAKE-FIGURE}
theme_set(theme_paper_ready(axis_size_adjust = -3))

top_row_OM_acum <- fig_5_tibble %>% 
  mutate(RSR=as.factor(RSR)) %>% 
  filter(Yr>80) %>% 
  ggplot(aes(x=Yr,y=CAR_g_yr,color=RSR,group=RSR)) + 
  geom_line() +
  facet_wrap(~sed_conc_mg_l,scales="free_y") +
  ylab("organic matter accumulation (g m^-1 yr^-1)")

bottom_row_accretion <- fig_5_tibble %>% 
  mutate(RSR=as.factor(RSR)) %>% 
  filter(Yr>80) %>% 
  ggplot(aes(x=Yr,y=accretion_mm_yr,color=RSR,group=RSR)) + 
  geom_line() +
  # facet_wrap(~sed_conc,scales="free_y") + 
  facet_wrap(~sed_conc_mg_l) + 
  ylab("Accretion rate (mm yr^-1)")

top_row_OM_acum / bottom_row_accretion + plot_layout(guides = 'collect')

```

