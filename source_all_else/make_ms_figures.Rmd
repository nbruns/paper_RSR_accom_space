---
title: Make figures for paper exploring how root to shoot ratio impacts acomodation
  space
author: "Nicholas Bruns"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
dir_name_c_model <- "~/projects/marsh_column_model-master/"
dir_name_r_project <- "~/projects/paper_RSR_accom_space/"
```

```{r load-data}

series_column_names <-c("Yr", "MHT", "Elevation", "Biomass", 
                        "Silt", "Ref", "Lab","extra_column")

series_column_names_ADD_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                        "Silt", "Ref", "Lab","Accretion_rate","extra_column")

file_name_vec <- c("series.00.txt", "series.01.txt", "series.10.txt", "series.11.txt")


run_string_vec <- c("00","01","10","11")

all_runs <- tibble()
for(cur_run_string in run_string_vec ){
  cur_file_name <- paste0("series.",cur_run_string,".txt")
    
  cur_data <- read_delim(
    paste0(dir_name_c_model,cur_file_name), 
    delim = " ", 
    col_names = series_column_names,
    trim_ws = TRUE) %>% 
    select(-extra_column) %>% 
    mutate(Yr=Yr+2010) %>% 
    mutate(run_code=cur_run_string)
   
  
  all_runs <- bind_rows(all_runs,cur_data) 
}

all_runs %>% glimpse()


```


```{r reproduce-k-mud-fig-3}

scenario_plot_CAR <- 
  
scenario_plot_accretion <-
  
scenario_plot_CAR | scenario_plot_accretion
  
```



```{r fig-1-rsr-adjust-LOAD-DATA}
dir_name_fig_2_results <- "RSR_adjust_constant_SLR"
run_dir_full_name<- paste0("../source_cpp_model/model_output/", dir_name_fig_2_results,"/")
                       
series_column_names_NO_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                          "Silt", "Ref", "Lab","extra_column")
  

  # run_string_vec <- c("00","01","10","11")
  # run_string_vec <- c( "0.000", "0.001", "0.005", "0.050")
  rsr_adjust_file_names <- list.files(run_dir_full_name)
 
   SLR_pattern <- "SLR_([0-9.]+)\\.txt" # regex for extracting SLR rate
   sed_pattern <- "sed_([0-9.]+)\\_" # regex for extracting SLR rate
   rsr_pattern <- "(?<=RSR2_)[0-9.]+" #"RSR2_([0-9.]+)\\_" # regex for extracting SLR rate
 
   
RSR_adjust_tibble <- tibble()
  for(cur_file_name in list.files(run_dir_full_name)){
    # cur_file_name <- equilibrium_run_files[4] #run name
    # slr_rate <- str_extract(cur_file_name, pattern) %>%  
   # cur_file_name <- rsr_adjust_file_names[2]
    cur_sed_conc <- str_extract(cur_file_name, sed_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      as.numeric()
   
    cur_rsr <-  str_extract(cur_file_name, rsr_pattern) %>%
    # str_extract(cur_file_name, rsr_pattern) %>%
      # str_extract("[0-9.]+")  %>% 
      as.numeric() 
      
    print(cur_rsr)
  
    cur_SLR <-  str_extract(cur_file_name, SLR_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
    
    cur_data <- read_delim(
      paste0(run_dir_full_name,cur_file_name),
      delim = " ", 
      col_names = series_column_names_NO_ACRETION,
      trim_ws = TRUE) %>% 
      select(-extra_column) %>% 
      # mutate(Yr=Yr+2010) %>%
        # filter(Yr>1980) %>%
      mutate(sed_conc=cur_sed_conc,
             SLR=cur_SLR,
             rsr=cur_rsr)
    
    cur_data <- cur_data %>% 
        mutate(accretion_mm_yr=Elevation-lag(Elevation)) %>% 
        mutate(accretion_mm_yr=accretion_mm_yr*1000) %>% 
        mutate(silt_deposition_g_yr=Silt - lag(Silt)) %>% 
        mutate(depth=MHT-Elevation) %>% 
        mutate(total_C=Ref+Lab) %>% 
        mutate(CAR_g_yr=total_C - lag(total_C)) 
        
    RSR_adjust_tibble <- bind_rows(RSR_adjust_tibble,cur_data) 
  }
 
  
  glimpse(RSR_adjust_tibble)

  RSR_adjust_tibble %>% pull(rsr) %>% table()
```
```{r fig-1-rsr-adjust-MAKE-PLOT}
# recquires RSR_adjust_tibble
fig_1_make_plot <- function(results_tibble_arg,slr_arg){
  
  low_sed <- results_tibble_arg %>% 
    # filter(rsr %in% c(1,3)) %>% 
    filter(rsr %in% c(1,4)) %>% 
    filter(sed_conc==.005) %>% 
    
    select(
     Yr,sed_conc,SLR,
     rsr,
     accretion_mm_yr,CAR_g_yr,Biomass,depth,silt_deposition_g_yr
    ) %>% 
    filter(Yr>50) %>% 
    filter(SLR==slr_arg) %>% 
    pivot_longer(-c(Yr,sed_conc,SLR,rsr)) %>% 
    ggplot(aes(x=Yr,y=value,group=as.factor(rsr),color=as.factor(rsr))) +
    geom_line() +
    # facet_grid(name~sed_conc,scales = "free_y") +
    facet_wrap(~name,scales = "free_y",ncol=1) +
    scale_color_manual(values= c("darkgreen","brown"),"root:shoot ratio") +
    ggtitle(paste0("SLR: ",slr_arg,", sed: 5 mg/L")) +
    ylab(NULL)
    # ggplot(aes(x=Yr,y=))
   # low_sed 
   
  high_sed <- results_tibble_arg %>% 
      # filter(rsr %in% c(1,3)) %>% 
      filter(rsr %in% c(1,4)) %>% 
    filter(sed_conc==.05) %>% 
    select(
     Yr,sed_conc,SLR,
     rsr,
     accretion_mm_yr,CAR_g_yr,Biomass,depth,silt_deposition_g_yr
    ) %>% 
    filter(Yr>50) %>% 
    filter(SLR==slr_arg) %>% 
    pivot_longer(-c(Yr,sed_conc,SLR,rsr)) %>% 
    ggplot(aes(x=Yr,y=value,group=as.factor(rsr),color=as.factor(rsr))) +
    geom_line() +
    # facet_grid(name~sed_conc,scales = "free_y") +
    facet_wrap(~name,scales = "free_y",ncol=1) +
    scale_color_manual(values= c("darkgreen","brown"),"root:shoot ratio") +
    ylab(NULL)+
    ggtitle(paste0("SLR: ",slr_arg,", sed: 50 mg/L")) 
    # ggplot(aes(x=Yr,y=))
   (low_sed  | high_sed) + plot_layout(guides = 'collect')
   
}


# fig_1_make_plot (RSR_adjust_tibble,.003) 
fig_1_make_plot (RSR_adjust_tibble,.01) 
# fig_1_make_plot (RSR_adjust_tibble,.001) 
 
 
```

```{r fig-2-delta-C-MAKE-DATA}
#could load these 1 at a time and make table, so I could sweep a larger set
compute_delta_C <- function(sed_conc_arg,slr_arg,RSR_change_arg){
  low_RSR <- 1 #could make this an arg
  
  # sed_conc_arg <- .05
  # slr_arg <- .01
  
  
  cur_run <- RSR_adjust_tibble %>% 
    filter(sed_conc==sed_conc_arg) %>% 
    filter(SLR==slr_arg) %>% 
    filter(rsr %in% c(1,RSR_change_arg)) 
  
  baseline_year <- 99 
  final_year <- 199
  baseline_CAR <- cur_run %>%
  # cur_run %>% 
    filter(Yr==baseline_year) %>% 
    filter(rsr==low_RSR) %>% #they are identical, so just grab the first
    pull(CAR_g_yr)
  
  final_CAR<- cur_run %>%
  # cur_run %>%
    filter(rsr==RSR_change_arg) %>% 
    filter(Yr==final_year) %>% 
    pull(CAR_g_yr)
    
  
  (final_CAR- baseline_CAR)/baseline_CAR
}


slr_vec <- RSR_adjust_tibble %>% pull(SLR) %>% unique() %>% as.numeric()
sed_conc_vec <- RSR_adjust_tibble %>% pull(sed_conc) %>% unique() %>% as.numeric()
RSR_vec <- RSR_adjust_tibble %>% pull(rsr) %>% unique() %>% as.numeric()

fig_2_tibble <- tibble()
for(cur_slr in slr_vec){
  for(cur_sed_conc in sed_conc_vec){
    for(cur_RSR in RSR_vec){
      # cur_sed_conc <- sed_conc_vec[1]
      # cur_slr <- slr_vec[1]
      # cur_RSR <- RSR_vec[1]
      
       cur_delta_c_pcnt <- compute_delta_C(
         sed_conc_arg = cur_sed_conc,
         slr_arg =  cur_slr,
         RSR_change_arg= cur_RSR)
       
       
       
       cur_row <- tibble(delta_c_pcnt=cur_delta_c_pcnt,
                         sed_conc=cur_sed_conc,
                         SLR=cur_slr,
                         RSR=cur_RSR
                         )
       fig_2_tibble <- bind_rows(fig_2_tibble,cur_row)
    }
  }
}

fig_2_tibble %>% glimpse()

```

```{r fig-2-delta-C-MAKE-PLOT}
   
fig_2_tibble %>% 
  filter(RSR %in% c(1,4)) %>% 
  ggplot(aes(x = SLR, y = delta_c_pcnt, color = as.factor(sed_conc*1000), group = interaction(sed_conc, RSR))) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  labs(color = "Sed. Conc. (mg/L)") +  # Optionally add a label for the legend
  scale_color_brewer(palette = "Set1")


```

```{r fig-2-delta-C-ALT-VIEW}
fig_2_tibble %>% 
  # filter(SLR %in% )
  filter(RSR %in% c(1,4)) %>% 
  ggplot(aes(x = sed_conc, y = delta_c_pcnt, color = as.factor(SLR), group = interaction(SLR, RSR))) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) +
  # labs(color = "Sed. Conc. (mg/L)") +  # Optionally add a label for the legend
  labs(color = "SLR (m/yr)") +  # Optionally add a label for the legend
  scale_color_brewer(palette = "Set1")

```



```{r fig-4-total-c-per-scenario-run-LOAD-DATA}
dir_name_fig_4_results <- "scenario_runs_fig_4"
run_dir_full_name<- paste0("../source_cpp_model/model_output/", run_dir_name,"/")
                       
series_column_names_NO_ACRETION <-c("Yr", "MHT", "Elevation", "Biomass", 
                          "Silt", "Ref", "Lab","extra_column")
  

  # run_string_vec <- c("00","01","10","11")
  # run_string_vec <- c( "0.000", "0.001", "0.005", "0.050")
  equilibrium_run_files <- list.files(run_dir_full_name)
 
   sed_pattern <- "sed_([0-9.]+)\\.txt" # regex for extracting SLR rate
   rsr_pattern <- "D_mbm_([0-9.]+)\\_" # regex for extracting SLR rate
 
   
  cur_result_tibble <- tibble()
  for(cur_file_name in equilibrium_run_files){
    # cur_file_name <- equilibrium_run_files[4] #run name
    # slr_rate <- str_extract(cur_file_name, pattern) %>%  
    sed_conc <- str_extract(cur_file_name, sed_pattern) %>%  
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
   
    rsr <-  str_extract(cur_file_name, rsr_pattern) %>%
      str_extract("[0-9.]+")  %>% 
      substr(1, nchar(.) - 1) %>%  
      as.numeric()
   
    print(rsr )
    print(sed_conc)
    
    cur_data <- read_delim(
      paste0(run_dir_full_name,cur_file_name),
      delim = " ", 
      col_names = series_column_names_NO_ACRETION,
      trim_ws = TRUE) %>% 
      select(-extra_column) %>% 
      # mutate(Yr=Yr+2010) %>%
        # filter(Yr>1980) %>%
      mutate(sed_conc=sed_conc) 
    
    #calculate additional fields 
    cur_data <- cur_data %>% 
      mutate(total_carbon=Lab+Ref)
    
    end_carbon <- cur_data %>% 
      slice_max(Yr) %>% pull(total_carbon)
    
    start_carbon <- cur_data %>% 
      filter(Yr==100) %>% 
      pull(total_carbon)
   
    carbon_accumulation <- end_carbon - start_carbon 
    cur_row <- tibble(carbon_accumulation,sed_conc,rsr)
    cur_result_tibble <- bind_rows(cur_result_tibble,cur_row) 
  }
  
  glimpse(cur_result_tibble)

```

```{r fig-4-total-c-per-scenario-run-MAKE-PLOT}
low_rsr_result_tibble

  cur_result_tibble %>% 
  mutate(sed_conc_mg=sed_conc*1000) %>% 
    ggplot(aes(x=rsr,y=carbon_accumulation,group=sed_conc_mg,color=as.factor(sed_conc_mg)))+
    geom_point() +
    geom_line() +
  scale_color_viridis_d( "sediment concentration (mg/L)") +
  ylab("carbon accumulated (g)") +
  xlab("root:shoot ratio") +
  ggtitle("C accumulated during 100 year A2 scenario")

```

